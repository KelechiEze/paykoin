rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // List of admin user IDs - These users can both send/transfer and withdraw
    function isAdmin() {
      return request.auth != null && 
             request.auth.uid in [
               "XxLSLbnvlNWUMRRUor9hHjAcjXn1",
               "jDDCKoecgkRLnVzbZ32vSEt7Cqk1",
               "FdQdoM56hqZwhjVsGuUoQyxQxtJ2",
               "gO8lvd3mhYZcZ0vQPVw12vdl7Tv1",
               "WCQ5TTYURpZBE4PvmcqMZCMOzCp1",
               "attp5t0hZOQsvtUOO4jg2od5Tt23",
               "3Ze6cejseWOOa2VsAM4d6TqAgOJ2",
               "xUVEf4geQgfzSotgAapPohpsqzP2",
               "e5Y1fa6BxuN2Zb2mTs1QBMcUXaE2",
               "nPLAxbXcZxcBQRwOErtZR7lPwnA2",
               "baIwY7dPCOhOT3irhIVAkBvuzQ72"
             ];
    }

    // Users who can send/transfer funds
    function canSend() {
      return request.auth != null && isAdmin();
    }

    // Users who can withdraw funds
    function canWithdraw() {
      return request.auth != null && isAdmin();
    }

    // USERS collection
    match /users/{userId} {

      // Create only if valid data OR admin
      allow create: if (
        (request.resource.data.email is string && 
         (request.resource.data.fullName is string || request.resource.data.displayName is string))
      ) || isAdmin();

      // Read/update/delete if owner or admin
      allow read, update, delete: if (request.auth != null && request.auth.uid == userId) || isAdmin();

      // WALLETS subcollection
      match /wallets/{walletId} {
        // Read/delete if owner or admin
        allow read, delete: if (request.auth != null && request.auth.uid == userId) || isAdmin();
        // Update if owner or admin
        allow update: if (request.auth != null && request.auth.uid == userId) || isAdmin();
        // Create if owner or admin
        allow create: if (request.auth != null && request.auth.uid == userId) || isAdmin();

        // TRANSACTIONS subcollection
        match /transactions/{transactionId} {
          // Create if owner can send or admin
          allow create: if (request.auth != null && request.auth.uid == userId) && canSend();
          // Read/update/delete if owner or admin
          allow read, update, delete: if (request.auth != null && request.auth.uid == userId) || isAdmin();
        }
      }

      // PAYMENT METHODS subcollection
      match /paymentMethods/{paymentMethodId} {
        // Create if owner or admin
        allow create: if (request.auth != null && request.auth.uid == userId) || isAdmin();
        // Read/update/delete if owner or admin
        allow read, update, delete: if (request.auth != null && request.auth.uid == userId) || isAdmin();
      }

      // SETTINGS subcollection
      match /settings/{settingId} {
        // Only owner or admin can manage settings
        allow read, create, update, delete: if (request.auth != null && request.auth.uid == userId) || isAdmin();
      }

      // DASHBOARD subcollection
      match /dashboard/{docId} {
        // Read/write if owner or admin
        allow read, write: if (request.auth != null && request.auth.uid == userId) || isAdmin();
      }

      // WITHDRAWAL REQUESTS subcollection
      match /withdrawalRequests/{requestId} {
        // Create if owner can withdraw or admin
        allow create: if (request.auth != null && request.auth.uid == userId) && canWithdraw();
        // Read if owner or admin
        allow read: if (request.auth != null && request.auth.uid == userId) || isAdmin();
        // Update only by admin (to process requests)
        allow update: if isAdmin();
        // Delete if owner or admin
        allow delete: if (request.auth != null && request.auth.uid == userId) || isAdmin();
      }
    }

    // ADMIN SETTINGS collection
    match /adminSettings/{docId} {
      // Only admins can access admin settings
      allow read, write: if isAdmin();
    }
  }
}